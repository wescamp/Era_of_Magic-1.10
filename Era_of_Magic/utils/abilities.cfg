#textdomain wesnoth-Era_of_Magic
# abilities
#define ABILITY_WATER
    [regenerate]
        value=6
        id=water
        name= _ "water"
        description= _ "Made of Water:
This unit is made of water. As a result, if it is standing in water, it will receive 6 hp."
        name_inactive= _ "waterhome"
        description_inactive= _ "waterhome:
This unit is made of water. If it stands in water, it will receive 6 hp."
        affect_self=yes
        poison=cured
        [filter_self]
            [filter_location]
                terrain=Wo,Ww,Ss
            [/filter_location]
        [/filter_self]
    [/regenerate]
#enddef

#define ABILITY_FIRE
    [regenerate]
        value=6
        id=fire
        name= _ "fire"
        description= _ "Made of Fire:
This unit is made of fire. If it stands in lava, it will receive 6 hp."
        name_inactive= _ "lavahome"
        description_inactive= _ "lavahome:
This unit is made of fire. If it stands in lava, it will receive 6 hp."
        affect_self=yes
        poison=cured
        [filter_self]
            [filter_location]
                terrain=Ql,Qlf
            [/filter_location]
        [/filter_self]
    [/regenerate]
#enddef

#define ABILITY_MEGACIRCLE
    [regenerate]
        value=8
        id=healing
        name= _ "megacircle"
        description= _ "megacircle:
This unit owns powerful magic circle which affects all units inside. All friendly units fight better (+125%, +100%, +75%, +50%, +25% — lvl 0, 1, 2, 3, 4) and regenerate themselves."
        affect_self=yes
        poison=cured
    [/regenerate]
    [heals]
        value=8
        id=healing
        affect_allies=yes
        affect_self=no
        poison=slowed
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/heals]
    [heals]
        affect_allies=yes
        id=curing
        affect_self=no
        poison=cured
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/heals]
    [leadership]
        id=leadership
        value=125
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=leadership
        value=100
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=leadership
        value=75
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=2
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=leadership
        value=50
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=3
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=leadership
        value=25
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=4
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

#define WEAPON_SPECIAL_CIRCLE
    [chance_to_hit]
        id=circle
        name= _ "always hits"
        description= _ "always hits:
This attack always has a 100% chance to hit"
        value=100
        cumulative=no
    [/chance_to_hit]
#enddef

#define WEAPON_SPECIAL_NOCOUNTERATTACK
    [attacks]
        id=nocounter
        name= _ "no counter-attack"
        description= _ "no counter-attack:
The opponent has always a 0% chance to hit, when this unit is attacking."
        name_inactive= _ "no counter-attack"
        description_inactive= _ "no counter-attack:
The opponent has always a 0% chance to hit, when this unit is attacking."
        value=0
        cumulative=no
        active_on=offense
        apply_to=opponent
    [/attacks]
#enddef

#define WEAPON_SPECIAL_EVASION
    [damage]
        id=evasion
        name= _ "evasion"
        name_inactive= _ "evasion"
        description= _ "Evasion:
When this attack is used offensively, this unit takes one third less damage in retaliation."
        description_inactive= _ "evasion:
When this attack is used offensively, this unit takes one third less damage in retaliation."
        active_on=offense
        apply_to=opponent
        multiply=0.66
    [/damage]
#enddef

#define ABILITY_DARKAURA
    [leadership]
        id=darkaura
        value=-25
        cumulative=no
        name= _ "dark aura"
        description= _ "Dark Aura:
Makes all adjacent enemy units fight worse (−25% for attack)."
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            #[filter]
            #	level=0
            #[/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

#define ABILITY_ULTRACURES
    [heals]
        value=12
        id=healing
        affect_allies=yes
        name= _ "ultracures"
        description=  _ "Heals +12:
Allows the unit to heal adjacent friendly units at the beginning of each turn.

A unit cared for by this healer may heal up to 12 HP per turn.
A curer can cure a unit of poison, although that unit will receive no additional healing on the turn it is cured of the poison."
        affect_self=no
        poison=cured
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/heals]
    [regenerate]
        value=12
        id=healing
        affect_self=yes
        poison=cured
    [/regenerate]
#enddef

#define ABILITY_I8PROTECTION
    [resistance]
        id=i8protection
        add=20
        max_value=40
        apply_to=blade,pierce,impact,fire,cold,arcane
        name= _ "defender"
        description= _ "Defender:
Adjacent friendly units receive a +20% bonus to all resistances (up to a maximum of 40%)."
        affect_self=no
        affect_allies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
        [filter_base_value]
            less_than=40
        [/filter_base_value]
    [/resistance]
#enddef

#define WEAPON_SPECIAL_PRECISION
    [chance_to_hit]
        id=precision
        name= _ "precision"
        description= _ "precision:
This attack always has a 80% chance to hit"
        value=80
        cumulative=no
    [/chance_to_hit]
#enddef

#define ABILITY_CIRCLERES
    [resistance]
        id=cr
        add=20
        max_value=100
        apply_to=fire,cold,arcane
        name= _ "circle of resistance"
        description= _ "Circle of Resistance:
This unit and all adjacent friendly units receive a +20% bonus to fire, cold, and arcane resistances."
        affect_self=yes
        affect_allies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/resistance]
#enddef

#define ABILITY_CIRCLESUS
    [resistance]
        id=cr
        add=-20
        max_value=0
        apply_to=fire,cold,arcane
        name= _ "circle of susceptibility"
        description= _ "Circle of Susceptibility:
All adjacent enemy units receive a -20% to fire, cold, and arcane resistances."
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/resistance]
#enddef

#define ABILITY_DEADZONE
    [resistance]
        id=deadzone
        add=99
        max_value=99
        apply_to=fire,cold,arcane
        name= _ "deadzone"
        description= _ "Deadzone:
Adjacent friendly units receive a 99% bonus to fire, cold, and arcane resistances."
        affect_self=yes
        affect_allies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/resistance]
#enddef

#define ABILITY_COLDAURA
    [resistance]
        id=coldaura
        add=50
        max_value=50
        apply_to=fire
        name= _ "cold aura"
        description= _ "Cold Aura:
Area around this unit provides a 50% bonus to fire resistance and a −25% bonus to cold resistance."
        affect_self=yes
        affect_allies=yes
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/resistance]
    [resistance]
        id=coldaura
        value=-25
        max_value=-25
        apply_to=cold
        affect_self=yes
        affect_allies=yes
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/resistance]
#enddef

###
###
###

#define WEAPON_SPECIAL_I8REVENGE
    [chance_to_hit]
        id=i8revenge
        name= _ "revenge"
        description= _ "revenge:
The unit has 100% hitting chance during retalitation."
        name_inactive= _ "revenge"
        description_inactive= _ "revenge:
The unit has 100% hitting chance during retalitation."
        value=100
        cumulative=no
        active_on=defense
        apply_to=self
    [/chance_to_hit]
#enddef
#######################

#define ABILITY_I8KAMIKAZE
    [dummy]
        id=i8 kamikaze
        name= _ "kamikaze"
        description= _ "Kamikaze:
This unit always hits a target when attacking, but it dies instantly."
    [/dummy] # a hack to please wmlxgettext (using a bug in wmlxgettext!): dummy tag start: [abilities]
[/abilities]

[event]
    name=attack_end
    first_time_only=no
    [filter]
        ability=i8 kamikaze
        x,y=$x1,$y1
    [/filter]
    [kill]
        x,y=$x1,$y1
        animate=no
    [/kill]
[/event]

[+abilities] # a hack to please wmlxgettext (using a bug in wmlxgettext!): dummy tag end: [/abilities]
#enddef

#define ABILITY_I8HITANDRUN
    [dummy]
        id=i8hitandrun
        name= _ "hit and run"
        description=_ "Hit and Run:
This unit gains 3 moves back after attacking, but cannot attack again."
    [/dummy] # a hack to please wmlxgettext (using a bug in wmlxgettext!): dummy tag start: [abilities]
[/abilities]
[event]
    name=attack_end
    first_time_only=no
    [filter]
        x,y=$x1,$y1
        ability=i8hitandrun
    [/filter]
    {VARIABLE_OP unit.moves add 3}
    [unstore_unit]
        variable=unit
        {COLOR_HARM}
        text= _ "FLEE!"
        find_vacant=no
    [/unstore_unit]
[/event]
[+abilities] # a hack to please wmlxgettext (using a bug in wmlxgettext!): dummy tag end: [/abilities]
#enddef

#define ABILITY_MOUNTAINAMBUSH
    [hides]
        id=mountainambush
        name= _ "mountain ambush"
        name_inactive= _ " mountain ambush"
        description= _ "Mountain Ambush:
This unit can hide in mountains and hills, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in mountains or hills, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        description_inactive= _ "Ambush:
This unit can hide in forest, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in mountains or hills, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        affect_self=yes
        [filter_self]
            [filter_location]
                terrain=At,Hd,Hh,Ds,Ha,Md,Mm,Ms
            [/filter_location]
        [/filter_self]
    [/hides]
#enddef

##########################
##########################

######################
#define ABILITY_I8FURY
    [dummy]
        id=i8fury
        name= _ "fury"
        description=_ "Fury:
This unit can attack another unit after killing an enemy."
    [/dummy] # a hack to please wmlxgettext (using a bug in wmlxgettext!): dummy tag start: [abilities]
[/abilities]
[event]
    name=die
    first_time_only=no
    [filter_second]
        side=$side_number
        ability=i8fury
    [/filter_second]

    [store_unit]
        variable=i8furious
        [filter]
            x,y=$x2,$y2
        [/filter]
    [/store_unit]
    {VARIABLE_OP i8furious.attacks_left add 1}
    [unstore_unit]
        variable=i8furious
        {COLOR_HARM}
        text= _ "FURY!"
        find_vacant=no
    [/unstore_unit]
[/event]
[+abilities] # a hack to please wmlxgettext (using a bug in wmlxgettext!): dummy tag end: [/abilities]
#enddef
######################

###########################
##########################
######################
#define I8FURIOUSDEATH_EVENT
    #Mad
    [event]
        name=die
        first_time_only=no
        [filter]
            type=I8 Barbarian_MadCyclop
        [/filter]

        [store_locations]
            x=$x1
            y=$y1
            variable=loc_store
            radius=1
        [/store_locations]
        {I8DAMAGE_HEX 2 18}
        {I8DAMAGE_HEX 5 18}
        {I8DAMAGE_HEX 6 18}
        {I8DAMAGE_HEX 4 18}
        {I8DAMAGE_HEX 1 18}
        {I8DAMAGE_HEX 0 18}
        #[unstore_unit]
        #variable=unit_store
        #	red=0
        #	green=127
        #	blue=127
        #	text=DAMAGE SPELL
        #[/unstore_unit]
    [/event]

#enddef

#define I8FURIOUSDEATH2_EVENT
    #Destroyer
    [event]
        name=die
        first_time_only=no
        [filter]
            type=I8 Barbarian_CyclopDestroyer
        [/filter]

        [store_locations]
            x=$x1
            y=$y1
            variable=loc_store
            radius=1
        [/store_locations]
        {I8DAMAGE_HEX 2 27}
        {I8DAMAGE_HEX 5 27}
        {I8DAMAGE_HEX 6 27}
        {I8DAMAGE_HEX 4 27}
        {I8DAMAGE_HEX 1 27}
        {I8DAMAGE_HEX 0 27}
        #[unstore_unit]
        #variable=unit_store
        #	red=0
        #	green=127
        #	blue=127
        #	text=DAMAGE SPELL
        #[/unstore_unit]
        {CLEAR_VARIABLE loc_store}
    [/event]

#enddef

#define ABILITY_I8FURIOUSDEATH
    [damage]
        id=i8furiousdeath
        name= _ "furious death"
        description= _ "Furious Death:
Moments before this unit's death, it flies into a fury. The unit with this ability attacks all adjacent units and then it finally dies."
    [/damage]
#enddef

#####
#####
#####

###
###
###
#define WEAPON_SPECIAL_I8BATTLEFRENZY
    [damage]
        id=i8battlefrenzy
        name= _ "battlefrenzy"
        name_inactive= _ "battlefrenzy"
        description= _ "Battlefrenzy:
When this attack is used, this units gets an extra strike and additional damage (+2) after each successful hit. Does not work on defense."
        description_inactive= _ "Battlefrenzy:
This unit gets one extra strike and additional damage (+2) with each hit during attack. Does not work on defense."
    [/damage]
#enddef

####
####
####
####
#define I8DAMAGE_HEX NO DMG

    [store_unit]
        [filter]
            x=$loc_store[{NO}].x
            y=$loc_store[{NO}].y
        [/filter]
        kill=no
        variable=mhd_store
    [/store_unit]
    [if]
        [have_unit]
            find_in=mhd_store
            [filter_adjacent]
                is_enemy=no
                ability=i8awake
            [/filter_adjacent]
        [/have_unit]
        [then]
            [store_unit]
                [filter]
                    x=$loc_store[{NO}].x
                    y=$loc_store[{NO}].y
                [/filter]
                kill=no
                variable=candidate.a
            [/store_unit]
        [/then]
    [/if]
    [if]
        [variable]
            name=mhd_store.hitpoints
            less_than_equal_to={DMG}
        [/variable]
        [then]
            [if]
                [have_unit]
                    x=$loc_store[{NO}].x
                    y=$loc_store[{NO}].y
                [/have_unit]
                [then]
                    [unstore_unit]
                        variable=mhd_store
                        {COLOR_HARM}
                        text="{DMG}"
                    [/unstore_unit]
                    [kill]
                        x=$loc_store[{NO}].x
                        y=$loc_store[{NO}].y
                        fire_event=yes
                        animate=yes
                    [/kill]
                [/then]
            [/if]
        [/then]
        [else]
            {VARIABLE dmgpuffer {DMG}}
            {VARIABLE_OP dmgpuffer multiply -1}
            {VARIABLE_OP mhd_store.hitpoints add $dmgpuffer}
            [unstore_unit]
                variable=mhd_store
                {COLOR_HARM}
                text="{DMG}"
            [/unstore_unit]
        [/else]
    [/if]

#enddef

###########
##########
#define I8HARDLANDING_EVENT
    #Flying Fortress
    [event]
        name=die
        first_time_only=no
        [filter]
            type=I8 AD_FlyingFortress,I8 AD_MD
        [/filter]

        [store_locations]
            x=$x1
            y=$y1
            variable=loc_store
            radius=1
        [/store_locations]
        {I8DAMAGE_HEX 2 17}
        {I8DAMAGE_HEX 5 17}
        {I8DAMAGE_HEX 6 17}
        {I8DAMAGE_HEX 4 17}
        {I8DAMAGE_HEX 1 17}
        {I8DAMAGE_HEX 0 17}
        {CLEAR_VARIABLE loc_store}
    [/event]

#enddef

#define ABILITY_I8HARDLANDING
    [dummy]
        id=i8hardlanding
        name= _ "hard landing"
        description= _ "Hard landing:
When this large unit is destroyed, it falls on a ground dealing damage to all adjacent units. "
    [/dummy]
#enddef
#########
#define ABILITY_I8PARACHUTE
    [dummy]
        id=i8parachute
        name= _ "parachute"
        description= _ "Parachute:
The pilot of this machine is equipped with parachute and he can survive a destruction of his vehicle."
    [/dummy]
#enddef

#define I8PARACHUTIST_EVENT
    [event]
        name=die
        first_time_only=no
        [filter]
            type=I8 AD_FlyingFortress
        [/filter]
        {PLACE_IMAGE halo/wreck.png $x1 $y1}
        [unit]
            type=I8 AD_Parachutist
            side=$unit.side
            x,y=$x1,$y1
            moves=0
            animate=yes
        [/unit]
    [/event]
#enddef
########

#define ABILITY_I8REPAIR5
    [heals]
        value=5
        id=i8repair
        affect_allies=yes
        name= _ "repairs +5"
        description=  _ "Repairs +5:
Allows the unit to repair adjacent friendly mechanical units at the beginning of each turn.

A unit cared for by this healer may heal up to 5 HP per turn."
        affect_self=no
        poison=cured
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                race=mechanical
            [/filter]
        [/affect_adjacent]
    [/heals]
#enddef

#define ABILITY_I8REPAIR8
    [heals]
        value=8
        id=i8repair
        affect_allies=yes
        name= _ "repairs +8"
        description=  _ "Repairs +8:
Allows the unit to repair adjacent friendly mechanical units at the beginning of each turn.

A unit cared for by this healer may heal up to 8 HP per turn."
        affect_self=no
        poison=cured
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                race=mechanical
            [/filter]
        [/affect_adjacent]
    [/heals]
#enddef

##############################

#define I8GRENADE_EVENT ATTACK_NAME
    #Grenade
    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            name={ATTACK_NAME}
        [/filter_attack]

        [store_locations]
            x=$x2
            y=$y2
            variable=loc_store
            radius=1
        [/store_locations]
        {I8DAMAGE_HEX 2 5}
        {I8DAMAGE_HEX 5 5}
        {I8DAMAGE_HEX 6 5}
        {I8DAMAGE_HEX 4 5}
        {I8DAMAGE_HEX 1 5}
        {I8DAMAGE_HEX 0 5}
        {CLEAR_VARIABLE loc_store}
    [/event]

#enddef

#define WEAPON_SPECIAL_I8GRENADE
    [damage]
        id=i8grenade
        name= _ "grenade"
        name_inactive= _ "grenade"
        description= _ "Grenade:
When this attack is used, all units adjacent to a target get damage. Does not work on defense."
        description_inactive= _ "Grenade:
When this attack is used, all units adjacent to a target get damage. Does not work on defense."
    [/damage]
#enddef

#define ABILITY_RUNEAURA
    [dummy]
        id=runeaura
        name= _ "rune aura"
        description= _ "Rune Aura:
When this ability is activated, all Rune Masters create special auras. Adjacent units on hexes: s, ne, nw receive a 99% bonus to fire, cold and arcane resistance. Other units receive a −99% bonus to fire, cold and arcane resistance. The transformation lasts for one turn. Transformed unit cannot attack."
    [/dummy] # a hack to please wmlxgettext (using a bug in wmlxgettext!): dummy tag start: [abilities]
[/abilities]

[event]
    name=start
    [if]
        [have_unit]
            ability=runeaura
        [/have_unit]
        [then]
            {RUNEAURA_MENU}
        [/then]
    [/if]
[/event]

[event]
    name=recruit
    [filter]
        ability=runeaura
    [/filter]
    {RUNEAURA_MENU}
[/event]

[event]
    name=post_advance
    [filter]
        ability=runeaura
    [/filter]
    {RUNEAURA_MENU}
[/event]

[+abilities] # a hack to please wmlxgettext (using a bug in wmlxgettext!): dummy tag end: [/abilities]
#enddef

#define RUNEAURA_MENU

    [set_menu_item]
        id=runeaura_menu
        description= _ "Activate Aura (24g)"
        [show_if]
        [/show_if]

        [filter_location]
            [filter]
                ability=runeaura
                side=$side_number
            [/filter]
        [/filter_location]
        [command]
            [store_gold]
                variable=actualgold
                side=$side_number
            [/store_gold]
            [if]
                [variable]
                    name=actualgold
                    greater_than=23
                [/variable]
                [then]
                    [message]
                        speaker=unit
                        image="portraits/ancient_dwarves/transparent/runemaster.png"
                        message= _ "Activate aura? (cost: 24g)"
                        [option]
                            message= {MENU_IMG_TXT "ad-dwarves/runemaster.png" {STR_NO} }
                            [command]
                            [/command]
                        [/option]

                        [option]
                            message= {MENU_IMG_TXT "ad-dwarves/runemaster2.png" {STR_YES} }
                            [command]
                                [gold]
                                    amount=-24
                                    side=$side_number
                                [/gold]
                                {TRANSFORM_UNIT type=I8_AD_RuneMaster I8_AD_RuneMaster2}
                            [/command]
                        [/option]
                    [/message]
                [/then]
                [else]
                    [print]
                        text= _ "You don’t have enough gold to activate the rune aura!"
                        size=18
                        red=255
                    [/print]
                [/else]
            [/if]
            [clear_variable]
                name=actualgold
            [/clear_variable]
        [/command]
    [/set_menu_item]
#enddef

#define ABILITY_RUNEAURAACTIVE
    [resistance]
        id=runeauraactive
        add=99
        max_value=99
        apply_to=fire,cold,arcane
        name= _ "rune aura"
        description= _ "Rune Aura:
Adjacent friendly units on hexes: s, ne, nw receive a 99% bonus to fire, cold and arcane resistance. Other units receive a −99% bonus to fire, cold and arcane resistance."
        affect_self=no
        affect_allies=yes
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,se,sw
        [/affect_adjacent]
    [/resistance]
    [resistance]
        id=runeauraactive
        value=-99
        max_value=-99
        apply_to=fire,cold,arcane
        affect_self=no
        affect_allies=yes
        affect_enemies=yes
        [affect_adjacent]
            adjacent=s,nw,ne
        [/affect_adjacent]
    [/resistance]
#enddef

#define WEAPON_SPECIAL_SWALLOW
    [damage]
        id=swallow
        name= _ "swallow +4"
        name_inactive= _ "swallow +4"
        description=_ "Swallow +4:
This unit gains 4 hitpoints added to its current health whenever it kills a living unit."
        description_inactive= _ "Swallow +4:
This unit gains 4 hitpoints added to its current health whenever it kills a living unit."
    [/damage]
#enddef

#define SWALLOW_EVENT
    [event]
        name=die
        first_time_only=no

        [filter]
            [not]
                [filter_wml]
                    [status]
                        not_living="yes"
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]

        [filter_second_attack]
            name=fangswyv
        [/filter_second_attack]

        [unstore_unit]
            variable=second_unit
            {COLOR_HEAL}
            text= _ "4"
            find_vacant=no
        [/unstore_unit]

        [object]
            silent=yes
            duration=forever

            [filter]
                x,y=$x2,$y2
            [/filter]

            [effect]
                apply_to=hitpoints
                increase=4
            [/effect]
        [/object]
    [/event]
#enddef

#define ABILITY_I8_SWAMPAMBUSH
    [hides]
        id=swampambush
        name= _ "swamp ambush"
        name_inactive= _ "swamp ambush"
        description= _ "Swamp Ambush:
This unit can hide in swamp, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in swamp, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        description_inactive= _ "Ambush:
This unit can hide in forest, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in swamp, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        affect_self=yes
        [filter_self]
            [filter_location]
                terrain=Ss
            [/filter_location]
        [/filter_self]
    [/hides]
#enddef

#define ABILITY_I8_WATERAMBUSH
    [hides]
        id=waterambush
        name= _ "water ambush"
        name_inactive= _ "water ambush"
        description= _ "water ambush:
This unit can hide in water, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in water, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        description_inactive= _ "Ambush:
This unit can hide in forest, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in water, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        affect_self=yes
        [filter_self]
            [filter_location]
                terrain=Ww,Wo
            [/filter_location]
        [/filter_self]
    [/hides]
#enddef

#define ABILITY_I8_CAVEAMBUSH
    [hides]
        id=caveambush
        name= _ "cave ambush"
        name_inactive= _ "cave ambush"
        description= _ "Cave Ambush:
This unit can hide in cave, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in cave, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        description_inactive= _ "Ambush:
This unit can hide in forest, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in cave, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        affect_self=yes
        [filter_self]
            [filter_location]
                terrain=Uu,Ur,Uh
            [/filter_location]
        [/filter_self]
    [/hides]
#enddef

#define ABILITY_I8REGENERATES4
    [regenerate]
        value=6
        id=regen4
        name= _ "regenerates +4"
        description= _ "Regenerates +4:
At the beginning of each turn this unit heals +4 hp. If it is poisoned, it will remove it instead of healing."
        name_inactive= _ "regenerates +4"
        description_inactive= _ "Regenerates +4:
At the beginning of each turn this unit heals +4 hp. If it is poisoned, it will remove it instead of healing."
        affect_self=yes
        poison=cured
    [/regenerate]
#enddef

######
#KIRIOS Beam Weapon

#define KIRIOS_OPPOSITE_SIDE CENTER_X CENTER_Y X Y VAR
    {VARIABLE x_odd {X}}

    {VARIABLE_OP x_odd modulo 2}

    {VARIABLE c_x {CENTER_X}}
    {VARIABLE c_y {CENTER_Y}}
    {VARIABLE s_x {X}}
    {VARIABLE s_y {Y}}

    {VARIABLE result_x {CENTER_X}}
    {VARIABLE result_y {CENTER_Y}}

    {IF_VAR s_x greater_than $c_x (
        [then]
            {VARIABLE_OP result_x sub 1}
        [/then]
    )}

    {IF_VAR s_x less_than $c_x (
        [then]
            {VARIABLE_OP result_x add 1}
        [/then]
    )}

    {IF_VAR s_x equals $c_x (
        [then]
            {IF_VAR s_y less_than $c_y (
                [then]
                    {VARIABLE_OP result_y add 1}
                [/then]
            )}

            {IF_VAR s_y greater_than $c_y (
                [then]
                    {VARIABLE_OP result_y sub 1}
                [/then]
            )}
        [/then]
    )}

    {IF_VAR x_odd equals 1 (
        [then]
            {IF_VAR s_y equals $c_y (
                [then]
                    {VARIABLE_OP result_y add 1}
                [/then]
            )}
        [/then]

        [else]
            {IF_VAR s_y equals $c_y (
                [then]
                    {VARIABLE_OP result_y sub 1}
                [/then]
            )}
        [/else]
    )}
    {VARIABLE {VAR}.x $result_x}
    {VARIABLE {VAR}.y $result_y}

    {CLEAR_VARIABLE c_x}
    {CLEAR_VARIABLE c_y}
    {CLEAR_VARIABLE s_x}
    {CLEAR_VARIABLE s_y}
    {CLEAR_VARIABLE result_x}
    {CLEAR_VARIABLE result_y}
    {CLEAR_VARIABLE x_odd}
#enddef

#define KIRIOS_BEAM WEAPON DMG
    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            name={WEAPON}
        [/filter_attack]

        {KIRIOS_OPPOSITE_SIDE $x2 $y2 $x1 $y1 target_hex}

        [store_unit]
            [filter]
                x,y=$target_hex.x,$target_hex.y
            [/filter]
            variable=third
        [/store_unit]

        [if]
            [variable]
                name=third.hitpoints
                less_than_equal_to={DMG}
            [/variable]
            [then]
                [if]
                    [have_unit]
                        x=$third.x
                        y=$third.y
                    [/have_unit]
                    [then]
                        [unstore_unit]
                            variable=third
                            {COLOR_HARM}
                            text="{DMG}"
                        [/unstore_unit]
                        [kill]
                            x=$third.x
                            y=$third.y
                            fire_event=yes
                            animate=yes
                        [/kill]
                    [/then]
                [/if]
            [/then]
            [else]
                {VARIABLE dmgpuffer {DMG}}
                {VARIABLE_OP dmgpuffer multiply -1}
                {VARIABLE_OP third.hitpoints add $dmgpuffer}
                [unstore_unit]
                    variable=third
                    {COLOR_HARM}
                    text="{DMG}"
                [/unstore_unit]
            [/else]
        [/if]

        {CLEAR_VARIABLE target_hex}
        {CLEAR_VARIABLE third}
    [/event]
#enddef

#define ABILITY_AWAKE
    [dummy]
        id=i8awake
        name= _ "awaken"
        description= _ "Awaken:
If a friendly adjacent unit with more than one hitpoint at the beginning of the battle dies, it is resurrected, gets +6 experience and remains in battle with one hitpoint. If it dies again (having one hitpoint), it will be killed for sure."
    [/dummy] # a hack to please wmlxgettext (using a bug in wmlxgettext!): dummy tag start: [abilities]
[/abilities]
[event]
    name=attack
    first_time_only=no
    [filter]
        [filter_adjacent]
            is_enemy=no
            ability=i8awake
        [/filter_adjacent]
        [not]
            [filter_wml]
                [status]
                    not_living=yes
                [/status]
            [/filter_wml]
        [/not]
    [/filter]
    [filter_second]
        [not]
            type=Walking Corpse,Souless,Necromancer
        [/not]
    [/filter_second]

    [store_unit]
        [filter]
            x,y=$x1,$y1
        [/filter]
        variable=candidate.a
    [/store_unit]
[/event]
[event]
    name=attack
    first_time_only=no
    [filter]
        [not]
            type=Walking Corpse,Souless,Necromancer
        [/not]
    [/filter]
    [filter_second]
        [filter_adjacent]
            is_enemy=no
            ability=i8awake
        [/filter_adjacent]
        [not]
            [filter_wml]
                [status]
                    not_living=yes
                [/status]
            [/filter_wml]
        [/not]
    [/filter_second]

    [store_unit]
        [filter]
            x,y=$x2,$y2
        [/filter]
        variable=candidate.d
    [/store_unit]
[/event]

[event]
    name=die
    first_time_only=no
    [filter]
        [filter_adjacent]
            is_enemy=no
            ability=i8awake
        [/filter_adjacent]
    [/filter]
    [filter_second]
        [not]
            [filter_wml]
                [status]
                    not_living=yes
                [/status]
            [/filter_wml]
        [/not]
    [/filter_second]
    [if]
        [variable]
            name=unit.id
            equals=$candidate.d.id
        [/variable]
        [and]
            [variable]
                name=candidate.d.hitpoints
                greater_than=1
            [/variable]
        [/and]
        [then]
            {VARIABLE unit.hitpoints 1}
            [if]
                [variable]
                    name=unit.gender
                    equals="female"
                [/variable]

                [then]
                    {VARIABLE_OP unit.experience add 6}
                    {VARIABLE_OP second_unit.experience sub 6}
                    [if]
                        [variable]
                            name=second_unit.experience
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE second_unit.experience 0}
                        [/then]
                    [/if]
                    [unstore_unit]
                        variable=unit
                        find_vacant=no
                        text= _ "female^awoken"
                        {COLOR_HEAL}
                    [/unstore_unit]
                    [unstore_unit]
                        variable=second_unit
                        find_vacant=no
                    [/unstore_unit]
                [/then]

                [else]
                    {VARIABLE_OP unit.experience add 6}
                    {VARIABLE_OP second_unit.experience sub 6}
                    [if]
                        [variable]
                            name=second_unit.experience
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE second_unit.experience 0}
                        [/then]
                    [/if]
                    [unstore_unit]
                        variable=unit
                        find_vacant=no
                        text= _ "awoken"
                        {COLOR_HEAL}
                    [/unstore_unit]
                    [unstore_unit]
                        variable=second_unit
                        find_vacant=no
                    [/unstore_unit]
                [/else]
            [/if]
            {CLEAR_VARIABLE candidate}
        [/then]
    [/if]
    [if]
        [variable]
            name=unit.id
            equals=$candidate.a.id
        [/variable]
        [and]
            [variable]
                name=candidate.a.hitpoints
                greater_than=1
            [/variable]
        [/and]
        [then]
            {VARIABLE unit.hitpoints 1}
            [if]
                [variable]
                    name=unit.gender
                    equals="female"
                [/variable]

                [then]
                    {VARIABLE_OP unit.experience add 6}
                    {VARIABLE_OP second_unit.experience sub 6}
                    [if]
                        [variable]
                            name=second_unit.experience
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE second_unit.experience 0}
                        [/then]
                    [/if]
                    [unstore_unit]
                        variable=unit
                        find_vacant=no
                        text= _ "female^awoken"
                        {COLOR_HEAL}
                    [/unstore_unit]
                    [unstore_unit]
                        variable=second_unit
                        find_vacant=no
                    [/unstore_unit]
                [/then]

                [else]
                    {VARIABLE_OP unit.experience add 6}
                    {VARIABLE_OP second_unit.experience sub 6}
                    [if]
                        [variable]
                            name=second_unit.experience
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE second_unit.experience 0}
                        [/then]
                    [/if]
                    [unstore_unit]
                        variable=unit
                        find_vacant=no
                        text= _ "awoken"
                        {COLOR_HEAL}
                    [/unstore_unit]
                    [unstore_unit]
                        variable=second_unit
                        find_vacant=no
                    [/unstore_unit]
                [/else]
            [/if]
            {CLEAR_VARIABLE candidate}
        [/then]
    [/if]
[/event]
[+abilities] # a hack to please wmlxgettext (using a bug in wmlxgettext!): dummy tag end: [/abilities]
#enddef

#define ABILITY_I8HEALS2
    [heals]
        value=2
        id=healing
        affect_allies=yes
        name= _ "heals +2"
        description=  _ "Heals +2:
Allows the unit to heal adjacent friendly units at the beginning of each turn.

A unit cared for by this healer may heal up to 2 HP per turn."
        affect_self=no
        poison=slowed
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
        [/affect_adjacent]
    [/heals]
#enddef

#define ABILITY_I8INSPIRE
    [leadership]
        id=leadership
        value=10
        cumulative=no
        name= _ "inspire"
        description= _ "Inspire:
This unit can inspire friendly units that are next to it, making them fight better.

Adjacent friendly level 0 units will do 25% more damage in battle.
Adjacent friendly level 1 units will do 10% more damage in battle."
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=leadership
        value=25
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

#define ABILITY_I8INSPIRE2
    [leadership]
        id=leadership
        value=10
        cumulative=no
        name= _ "inspire"
        description= _ "Inspire:
This unit can inspire friendly units that are next to it, making them fight better.

Adjacent friendly level 0 units will do 25% more damage in battle.
Adjacent friendly level 1 units will do 25% more damage in battle.
Adjacent friendly level 2 units will do 10% more damage in battle."
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=leadership
        value=10
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=2
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=leadership
        value=25
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

######
#define ABILITY_I8TERROR_LEVEL_1
    [leadership]
        id=terror
        value=-30
        cumulative=no
        name= _ "awe"
        description= _ "Awe:
This unit can frighten enemy units that are next to it, making them fight worse.

Adjacent enemy units of lower level will do less damage in battle. When a unit adjacent to, of the same level, or a lower level than, and is an enemy of the unit with Awe engages in combat, its attacks do 15% less damage times the difference in their levels + 15%."
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-15
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

#define ABILITY_I8TERROR_LEVEL_2
    [leadership]
        id=terror
        value=-45
        cumulative=no
        name= _ "awe"
        description= _ "Awe:
This unit can frighten enemy units that are next to it, making them fight worse.

Adjacent enemy units of lower level will do less damage in battle. When a unit adjacent to, of the same level, or a lower level than, and is an enemy of the unit with awe engages in combat, its attacks do 15% less damage times the difference in their levels + 15%."
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-30
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-15
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=2
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

#define ABILITY_I8TERROR_LEVEL_3
    [leadership]
        id=terror
        value=-60
        cumulative=no
        name= _ "awe"
        description= _ "Awe:
This unit can frighten enemy units that are next to it, making them fight worse.

Adjacent enemy units of lower level will do less damage in battle. When a unit adjacent to, of the same level, or a lower level than, and is an enemy of the unit with awe engages in combat, its attacks do 15% less damage times the difference in their levels + 15%."
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-45
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-30
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=2
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-15
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=3
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

#define WEAPON_SPECIAL_BANISH
    [damage]
        id=banish
        name= _ "banish"
        name_inactive= _ "banish"
        description=_ "Banish:
If a Banisher hits an enemy magical unit, the enemy will turn into a DG ‘Dimensional Gate’, (this happens only if the target is exactly one level below the banisher). If the enemy is at least two levels below your banisher, it’ll get completely destroyed. Any other enemy won’t be affected."
        description_inactive= _ "banish:
If a Banisher hits an enemy magical unit, the enemy will turn into a DG ‘Dimensional Gate’, (this happens only if the target is exactly one level below the banisher). If the enemy is at least two levels below your banisher, it’ll get completely destroyed. Any other enemy won’t be affected."
    [/damage]
#enddef

#define BANISHER_EVENT
    [event]
        first_time_only=no
        name=attacker hits
        [filter]
            type=I8 Ak_Dispeller,I8 Ak_Banisher
        [/filter]
        [filter_attack]
            name=banishment
        [/filter_attack]
        [filter_second]
            race=I8 magical
        [/filter_second]

        [if]
            [have_unit]
                race=I8 magical
                x,y=$x2,$y2
                level=1
            [/have_unit]
            [and]
                [have_unit]
                    x,y=$x1,$y1
                    level=2
                [/have_unit]
            [/and]
            [then]
                {ADVANCE_UNIT x,y=$x2,$y2 (I8 Ak_Enchanted)}
                [store_unit]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    variable=dg
                    kill=yes
                [/store_unit]
                {VARIABLE dg.attacks_left 0}
                {VARIABLE dg.moves 0}
                [unstore_unit]
                    variable=dg
                    find_vacant=no
                [/unstore_unit]
                #{CLEAR_VARIABLE dg}
            [/then]
            [else]
                [if]
                    [have_unit]
                        race=I8 magical
                        x,y=$x2,$y2
                        level=1,0
                    [/have_unit]
                    [and]
                        [have_unit]
                            x,y=$x1,$y1
                            level=3
                        [/have_unit]
                    [/and]
                    [then]
                        [kill]
                            x,y=$x2,$y2
                            animate=yes
                        [/kill]
                    [/then]
                    [else]
                        [if]
                            [have_unit]
                                race=I8 magical
                                x,y=$x2,$y2
                                level=2
                            [/have_unit]
                            [and]
                                [have_unit]
                                    x,y=$x1,$y1
                                    level=3
                                [/have_unit]
                            [/and]
                            [then]
                                {ADVANCE_UNIT x,y=$x2,$y2 (I8 Ak_Enchanted2)}
                                [store_unit]
                                    [filter]
                                        x,y=$x2,$y2
                                    [/filter]
                                    variable=dg
                                    kill=yes
                                [/store_unit]
                                {VARIABLE dg.attacks_left 0}
                                {VARIABLE dg.moves 0}
                            [/then]
                            [else]
                                [if]
                                    [have_unit]
                                        race=I8 magical
                                        x,y=$x2,$y2
                                        level=0
                                    [/have_unit]
                                    [and]
                                        [have_unit]
                                            x,y=$x1,$y1
                                            level=2,3
                                        [/have_unit]
                                    [/and]
                                    [then]
                                        [kill]
                                            x,y=$x2,$y2
                                            animate=no
                                        [/kill]
                                    [/then]
                                [/if]
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/else]
        [/if]
    [/event]
    [event]
        first_time_only=no
        name=attack end
        [if]
            [variable]
                name=dg.length
                greater_than=0
            [/variable]
            [then]
                [unstore_unit]
                    variable=dg
                    find_vacant=no
                [/unstore_unit]
                {CLEAR_VARIABLE dg}
            [/then]
        [/if]
    [/event]
#enddef

#define ABILITY_CIRCLE_OF_BANISHMENT
    [leadership]
        id=cob
        value=-40
        cumulative=no
        name= _ "circle of banishment"
        description= _ "circle of banishment:
This unit can affect enemy magical units that are next to it, making them fight worse.

Adjacent enemy magical units of lower level will do less damage in battle. When a unit adjacent to, of the same level, or a lower level than, and is an enemy of the unit with Circle of Banishment engages in combat, its attacks do less damage (−40% lvl0, −30% lvl1, −15% lvl2, −10% lvl3)."
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
                race=I8 magical
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-30
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
                race=I8 magical
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-15
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=2
                race=I8 magical
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-10
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=3
                race=I8 magical
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef
